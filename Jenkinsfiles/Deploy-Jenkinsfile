pipeline {
    agent any

    environment {
        GIT_BRANCH = 'develop'
        GITHUB_KEY_ID = 'github_key'
    }

    stages {
        stage('Versioning') {
            steps {
                script {
                    def hasTags = sh(script: 'git tag -l', returnStatus: true) == 0
                    def currentVersion = hasTags ? sh(script: 'git describe --tags --abbrev=0', returnStdout: true).trim() : '0.1.0'
                    def (major, minor, patch) = currentVersion.tokenize('.').collect { it.toInteger() }
                    patch += 1
                    def newVersion = "${major}.${minor}.${patch}"
                    sh "git commit -am 'Increment version to ${newVersion}'"
                    sh "git tag -a ${newVersion} -m 'Version ${newVersion}'"
                    sh "git push origin ${GIT_BRANCH} --tags"
                }
            }
        }
    }
}
